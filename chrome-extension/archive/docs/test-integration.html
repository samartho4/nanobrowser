<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini Nano Integration Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h1 { color: #333; margin-top: 0; }
    
    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
      font-weight: 500;
    }
    
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    
    .output {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .instructions {
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    
    .instructions h3 { margin-top: 0; color: #004085; }
    .instructions code {
      background: #fff;
      padding: 2px 6px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Gemini Nano Integration Test</h1>
    
    <div class="instructions">
      <h3>Quick Test Instructions</h3>
      <p>1. Make sure you have the extension loaded in Chrome Canary</p>
      <p>2. Ensure Gemini Nano flags are enabled (see your screenshot)</p>
      <p>3. Click the buttons below to test the integration</p>
    </div>
    
    <div id="status" class="status info">Ready to test...</div>
    
    <div>
      <button onclick="testDirectAPI()">Test Direct API (window.ai)</button>
      <button onclick="testViaExtension()">Test Via Extension Bridge</button>
      <button onclick="testQuickGeneration()">Quick Generation Test</button>
    </div>
    
    <div id="output" class="output" style="display: none;"></div>
  </div>

  <script>
    function log(message) {
      const output = document.getElementById('output');
      output.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();
      output.textContent += `[${timestamp}] ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }
    
    function clearOutput() {
      document.getElementById('output').textContent = '';
    }
    
    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
    }
    
    async function testDirectAPI() {
      clearOutput();
      log('Testing direct window.ai API access...\n');
      
      try {
        const ai = window.ai;
        
        if (!ai) {
          log('‚ùå window.ai is not available');
          updateStatus('window.ai not available', 'error');
          return;
        }
        
        log('‚úÖ window.ai is available');
        log('Checking ai.LanguageModel...');
        
        if (ai.LanguageModel) {
          log('‚úÖ ai.LanguageModel found');
          
          const status = await ai.LanguageModel.availability();
          log(`Status: ${status}`);
          
          if (status === 'readily' || status === 'available') {
            log('\nCreating session...');
            const session = await ai.LanguageModel.create({
              outputLanguage: 'en'
            });
            
            log('‚úÖ Session created');
            log('Sending prompt...');
            
            const response = await session.prompt('Say hello in one sentence.');
            log(`\n‚úÖ Response: ${response}`);
            
            session.destroy();
            updateStatus('Direct API test passed!', 'success');
          } else {
            log(`‚ö†Ô∏è API status: ${status}`);
            updateStatus('API not ready', 'error');
          }
        } else {
          log('‚ùå ai.LanguageModel not found');
          updateStatus('LanguageModel not available', 'error');
        }
      } catch (error) {
        log(`‚ùå Error: ${error.message}`);
        console.error(error);
        updateStatus('Test failed', 'error');
      }
    }
    
    async function testViaExtension() {
      clearOutput();
      log('Testing via extension bridge (postMessage)...\n');
      
      try {
        // Listen for response
        const responsePromise = new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error('Timeout waiting for response'));
          }, 10000);
          
          const handler = (event) => {
            if (event.source !== window) return;
            
            const message = event.data;
            if (message.type === 'nano:response' && message.id === 'test-123') {
              clearTimeout(timeout);
              window.removeEventListener('message', handler);
              resolve(message.payload);
            } else if (message.type === 'nano:error' && message.id === 'test-123') {
              clearTimeout(timeout);
              window.removeEventListener('message', handler);
              reject(new Error(message.error));
            }
          };
          
          window.addEventListener('message', handler);
        });
        
        log('Sending detection request via postMessage...');
        window.postMessage({
          type: 'nano:detect',
          id: 'test-123'
        }, window.location.origin);
        
        const result = await responsePromise;
        log(`\n‚úÖ Response received:`);
        log(JSON.stringify(result, null, 2));
        
        if (result.promptAPI) {
          log('\n‚úÖ Prompt API is available via bridge!');
          updateStatus('Extension bridge test passed!', 'success');
        } else {
          log('\n‚ö†Ô∏è Prompt API not available');
          updateStatus('Prompt API not available', 'error');
        }
      } catch (error) {
        log(`‚ùå Error: ${error.message}`);
        console.error(error);
        updateStatus('Bridge test failed', 'error');
      }
    }
    
    async function testQuickGeneration() {
      clearOutput();
      log('Testing quick text generation...\n');
      
      try {
        const ai = window.ai;
        
        if (!ai?.LanguageModel) {
          log('‚ùå API not available');
          updateStatus('API not available', 'error');
          return;
        }
        
        log('Creating session...');
        const session = await ai.LanguageModel.create({
          outputLanguage: 'en'
        });
        
        const prompts = [
          'What is 2+2?',
          'Name a color.',
          'Say "test successful" if you can read this.'
        ];
        
        for (const prompt of prompts) {
          log(`\nPrompt: ${prompt}`);
          const response = await session.prompt(prompt);
          log(`Response: ${response}`);
        }
        
        session.destroy();
        log('\n‚úÖ All tests completed!');
        updateStatus('Quick generation test passed!', 'success');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`);
        console.error(error);
        updateStatus('Generation test failed', 'error');
      }
    }
    
    // Check API availability on load
    window.addEventListener('load', () => {
      if (window.ai?.LanguageModel) {
        updateStatus('‚úÖ Gemini Nano API detected! Ready to test.', 'success');
      } else {
        updateStatus('‚ö†Ô∏è Gemini Nano API not detected. Check setup.', 'error');
      }
    });
  </script>
</body>
</html>
