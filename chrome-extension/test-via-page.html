<!DOCTYPE html>
<html>

<head>
    <title>Test Nano Bridge</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
        }

        #output {
            background: #f0f0f0;
            padding: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Test Nano Bridge</h1>
    <p>This page tests if the inject script can receive messages from the page context.</p>
    <button onclick="testBridge()">Test Bridge</button>
    <pre id="output"></pre>

    <script>
        function log(msg) {
            const output = document.getElementById('output');
            output.textContent += msg + '\n';
            console.log(msg);
        }

        function testBridge() {
            log('=== Testing bridge ===');
            log('');

            let responseReceived = false;

            // Listen for response FIRST
            const handler = (e) => {
                if (e.source !== window) return;
                log('Received message: ' + e.data.type);

                if (e.data.type === 'nano:response' && e.data.id === 'page-test') {
                    log('✅ Got response: ' + JSON.stringify(e.data.payload, null, 2));
                    responseReceived = true;
                    window.removeEventListener('message', handler);
                } else if (e.data.type === 'nano:error' && e.data.id === 'page-test') {
                    log('❌ Got error: ' + e.data.error);
                    responseReceived = true;
                    window.removeEventListener('message', handler);
                }
            };

            window.addEventListener('message', handler);
            log('Listener registered');

            // Send message
            log('Sending nano:detect message...');
            window.postMessage({ type: 'nano:detect', id: 'page-test' }, '*');
            log('Message sent');

            // Timeout check
            setTimeout(() => {
                if (!responseReceived) {
                    log('');
                    log('⚠️ No response received after 3 seconds');
                    log('Check console for [Nano Inject] logs');
                    window.removeEventListener('message', handler);
                }
            }, 3000);
        }

        // Auto-run test on load
        window.addEventListener('load', () => {
            setTimeout(testBridge, 500);
        });
    </script>
</body>

</html>